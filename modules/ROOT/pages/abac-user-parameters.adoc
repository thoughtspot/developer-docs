= ABAC via tokens
:toc: true
:toclevels: 2

:page-title: ABAC via tokens
:page-pageid: abac-user-parameters
:page-description: Attribute-based access control pattern can be achieved via user parameters sent in the login token

ThoughtSpot's Attribute-Based Access Control (ABAC) implementation allows administrators to send user-specific security entitlements as attributes at session creation via JSON Web Token (JWT) tokens.

== Overview

The ABAC implementation allows sending user-specific data security rules and is typically used in embedded analytics scenarios where each user may need different data access. To generate JWT tokens for ABAC implementation, you must use the `/api/rest/2.0/auth/token/custom` REST API endpoint.

The legacy ABAC implementation allows passing runtime filters and Parameters as attributes in security entitlements in the token.

Starting with 10.15.0.cl, ThoughtSpot introduces a new approach to ABAC implementation that leverages (Row Level Security) RLS with xref:formula-variables.adoc[formula variables]. If you want to implement a more robust and secure access control for your application users, ThoughtSpot recommends using RLS rules or migrating to the new ABAC method that uses RLS with formula variables.

[NOTE]
====
* Use runtime filters / parameters to apply a filter that controls the user experience and applies relevant context from the host application.

* Runtime filters and runtime parameters are not security features. For data security and to limit access to the overall dataset, ThoughtSpot recommends using xref:rls-rules.adoc[Row-level security (RLS rules)].
====

=== ABAC attributes

The attributes for ABAC tokens vary based on the type of implementation you choose. The following options are available:

* ABAC via RLS with formula variables (Recommended for robust security controls) +
In this method, you'll be using formula variables (`variable_values`) and the RLS rules to define security entitlements. You can create a formula variable of any data type at the Org level or for all Orgs on your instance.
+
If the formula variables are available in ThoughtSpot, administrators can assign values to these variables during token generation and then define the RLS rules on the underlying Table with variable references in the formula. The RLS rules will apply to the Models, Liveboards, and other objects derived from that Table. Administrators can also set the scope of these variables to a specific Model derived from the Table on which the RLS rules will be applied.

* ABAC with runtime filters (Legacy implementation) +
This method uses xref:runtime-filters.adoc[runtime filters] (`filter_rules`) in the token to create data security rules. It can filter multiple values of any data type and binds to any Column in any Model with a matching column name in ThoughtSpot.

* ABAC with runtime Parameters (Legacy) +
This method uses xref:runtime-parameters.adoc[runtime Parameters] (`parameter_values`) in the token to create data security rules. It binds a single value to any Parameter in any Model by Parameter Name and Type match. Parameters can be used in *Formulas* and then as *Filters* in  Models.

[NOTE]
====
Formula variables are supported on ThoughtSpot 10.15.0.cl or later versions. If you want to migrate your implementation from the legacy method to the new approach with formula variables and RLS rules, contact ThoughtSpot Support.
====

=== Session-based rules

The ABAC implementation with formula variables and RLS does not support session-based ABAC rules, so we do not recommend setting the `persist_option` attribute to `NONE`. You can append or replace the attributes by setting the `persist_option` to `APPEND` or `REPLACE`.

This ABAC method also does not support resetting the variable attributes via `"persist_option": "RESET`. If you don't want to append or replace any attributes, do not pass any variable values in the token update request.

==== Persist options in the legacy ABAC method

In the ABAC implementation with only filter attributes and Parameters, administrators can configure the token properties to apply security attributes only to the current session or save the attributes in the user’s profile, so that the filter attributes persist for all future sessions and scheduled reports.

If the persist option is set `NONE` in the token, the filter rules and parameter values apply only to that specific session and are not saved to the user profile.  If `persist_option` is set to `APPEND`, `REPLACE`, or `RESET`, the API updates the user's properties in the user profile immediately upon a successful request, even if the generated token is never used. The user’s stored properties are updated as soon as the token request succeeds, not when the token is first used.

=== Mandatory token filters

The `is_mandatory_token_filter: true` setting in object TML enforces that a filter rule must be provided for a specific column. When this attribute is set on a column in a Model, ThoughtSpot will deny all data access for users who do not have a corresponding filter rule for that column in their ABAC token.

When setting filter rules within the token, you must place the `is_mandatory_token_filter: true` property on every column in a Model where a filter rule is expected. This setting will deny any access to data if a user has not been assigned values for the expected set of fields.

[#column-name-warning]
The filter rules require passing the *exact* column name as defined in the Model. Otherwise, the values will not bind to any column. You must coordinate between the team that maintains the data objects and the team that builds the xref:trusted-auth-token-request-service.adoc[token request service] to know if any changes will be made to a Model and to ensure column names remain consistent. +
For this reason, end users of an embedded app must not be granted edit access to any Model using ABAC rules via tokens. Setting the `is_mandatory_token_filter: true` property on every column where a filter rule is expected ensures that no data is returned for users when column names change.

[NOTE]
====
If a column is set with both `is_hidden: true` and `is_mandatory_token_filter: true`, and filter conditions for that column are defined in the ABAC token, the filter will be applied as expected. The column will be hidden from the user interface, but the mandatory filter requirement will still be enforced, and data will be shown according to the filter values provided in the token.
====

=== Indexing
Several features within ThoughtSpot, such as autocompletion in Search on values within columns or the suggestions in *Explore* mode, use ThoughtSpot indexing. Due to the runtime nature of ABAC via tokens, ThoughtSpot indexing will not be restricted by the values supplied in a token. This means the indexed columns may expose values in search suggestions or autocompletion that a user should not see, even if ABAC filters would block access to the underlying data. To prevent this, you can do one of the following:

- Disable indexing for columns and fields that must be restricted by ABAC. You may also want to disable indexing on all sensitive columns.
- Define an RLS rule on those fields, since RLS is enforced at the indexing layer and will secure suggestions and sample values.

=== ABAC tokens
The ABAC message to ThoughtSpot is encoded in JSON Web Token (JWT) format. This token can be used as a bearer token for Cookieless trusted authentication or REST API access. You can also use it as a sign-in token to create a session, in which case, ThoughtSpot recommends that the ABAC user properties be *persisted* to ensure scheduled exports remain secure after the session ends.

[NOTE]
====
ThoughtSpot compresses the size of the JWT token by default to ensure that larger payloads, for instance, more complex filtering conditions can be passed via JWT. ThoughtSpot recommends leaving that compression on to ensure all JWT tokens can get properly interpreted by the application regardless of their size, and to obfuscate the values passed in the JWT payload. However, if you want to decode the JWT token and decode the values of the token (at the expense of compression), contact ThoughtSpot Support.
====

=== Limitations

The ABAC via tokens method requires xref:trusted-authentication.adoc[trusted authentication] setup.

For indexing recommendations, see xref:abac-user-parameters.adoc#_indexing[Indexing].

== ABAC via RLS with formula variables
The ABAC implementation with formula variables and RLS rules involves the following steps:

* xref:abac-user-parameters.adoc#_create_formula_variables[Creating formula variables]
* xref:abac-user-parameters.adoc_define_values_and_scope_for_variables[Assigning values and scope for variables and generating an ABAC token]
* xref:abac-user-parameters.adoc#_define_rls_rules_with_formula_variable[Adding RLS rules with formula variables]
* xref:abac-user-parameters.adoc#_verify_entitlements[#Verifying entitlements]

=== Create formula variables
To create formula variables, use the xref:variables.adoc#_create_a_variable[Variable REST API].

Before generating the token request, verify if the variables are available on your instance and Org context using the `POST /api/rest/2.0/template/variables/search` API call.

You can assign variable values and set the scope in the `variable_values` and `objects` properties in your API request to the `/api/rest/2.0/auth/token/custom` endpoint.

=== Create an ABAC token request with formula variables

To generate a token with formula variable attributes, send a `POST` request to the `POST /api/rest/2.0/auth/token/custom` API endpoint with the following parameters in the request body:

==== Request parameters
[width="100%" cols="2,4"]
[options='header']
|=====
|Parameter|Description
|`username`
|__String__. Username of the ThoughtSpot user. If the user is not available in ThoughtSpot, a new user account will be created and added to ThoughtSpot.
|`secret_key`
|__String__. The secret key string provided by the ThoughtSpot server. ThoughtSpot generates this secret key xref:trusted-authentication.adoc#trusted-auth-enable[when trusted authentication is enabled].
|`variable_values`  a| Array of formula variables and values for each variable. Define the following attributes for each variable:

* `name` - Name of the formula variable. The formula variable referenced on the token request must be available in ThoughtSpot.
* `values` - Variable values. Ensure that the assigned value matches the data type set for the variable during creation. For example, if you are adding a variable to filter by country, you can specify the string values. For example:

[source,cURL]
----
variable_values": [
    {
      "name": "country_var",
      "values": [
        "Japan",
        "Singapore",
        "Australia"
      ]
    }
  ]
----

All values are passed into the token as *arrays of strings*, even if the column is a numeric, boolean, or date type in ThoughtSpot and the database. The column data type will be respected in the query issued to the database.

You can also set `TS_WILDCARD_ALL` to allow access to all. Ensure that the RLS rules are defined clearly to protect data if you must pass `TS_WILDCARD_ALL`  as value in the token request.

|`validity_time_in_sec` +
__Optional__| __Integer__. Token expiry duration in seconds. The default duration is 300 seconds.
|`org_id` +
__Optional__|__Integer__. If your instance has Orgs and want to create a token for a user in a specific Org, include the name or ID of the Org. If an Org ID is not specified, the token is generated for the Primary Org (Org 0).
|`persist_option` a| Specifies whether the rules should persist for user sessions. The following options are available:

* `APPEND` (default) +
Adds the attributes defined in the API request to the user properties. These properties will be applied to the current and future user sessions and for scheduled jobs until they are explicitly changed through a token update request.

* `REPLACE` +
Replaces existing variable assignments with the new values.

* `NONE` +
Not supported for variable values.

* `RESET` +
Not supported for variable values.

|`objects` +
__Optional__ a|__Array of strings__. An array of Model names or GUIDs to which you want to apply the security rules. The default object `type` `LOGICAL_TABLE`.

If no object is specified in the API request, the attributes will be applied to all `LOGICAL_TABLE` objects derived from the Table on which the RLS rules with formula variables are defined.

|`email` +
__Optional__ |__String__. Email address of the user. Use this parameter to add the email address of the user if `auto_create` is set to `true`.
|`display_name` +
__Optional__ |__String__. Display name of the user. Use this parameter if `auto_create` is set to `true.
|`auto_create` +
__Optional__|__Boolean__. Creates a user if the specified username is not already available in ThoughtSpot. The default value is `true`.
|=====

==== Example request
The following example shows the request body for generating a token with formula variable attributes:

[source,cURL]
----
 curl -X POST \
  --url 'https://{ThoughtSpot-Host}/api/rest/2.0/auth/token/custom'  \
  -H 'Accept: application/json' \
  -H 'Content-Type: application/json' \
  --data-raw '{
  "username": "UserA",
  "validity_time_in_sec": 300,
  "persist_option": "APPEND",
  "auto_create": true,
  "secret_key": "f8aa445b-5ff1-4a35-a58f-e324133320d5",
  "variable_values": [
    {
      "name": "country_var",
      "values": [
        "Japan",
        "Singapore",
        "Australia"
      ]
    },
    {
      "name": "dept_var",
      "values": [
        "Sales",
        "Marketing"
      ]
    }
  ],
  "objects": [
    {
      "type": "LOGICAL_TABLE",
      "identifier": "35aa85fe-fbb4-4862-a335-f69679ebb6e0"
    }
  ]
}'
----

If the request is successful, ThoughtSpot generates a token and sends it in the API response.

To verify the assignment, use the `/api/rest/2.0/users/search` REST API endpoint and check the access control attributes returned in the API response.

[source,JSON]
----
//...
{
  "variable_values": {
    "821119045": {
      "ALL": {
        "variable_values": [
          {
            "name": "country_var",
            "values": [
              "Japan",
              "Singapore",
              "Australia"
            ]
          },
          {
            "name": "dept_var",
            "values": [
              "Sales",
              "Marketing"
            ]
          }
        ]
      }
    }
  }
}
----

=== Define RLS rules with formula variable
Although the variable values and their scope are assigned in the token request, these attributes only take effect if they are referenced in an RLS rule. If the variables are not used in any formula or RLS rule, they will have no impact on data access. Therefore, you must xref:formula-variables.adoc#_add_variable_references_in_rls_rules[add RLS rules to the Table].

If you want to set the scope of variable attributes to a Model, ensure that the RLS rules are defined on the underlying Table from which the Model is derived.

When defining RLS rules, you must prefix `ts_var` to the formula variable reference in the formula. For example, if you want to limit user access to data of a specific region, you can create a region-specific variable, assign values in the token request, and then add a rule on the underlying Table.

In this example, `country_var` is referenced in the RLS rule to limit user access to country-specific data.

----
country = ts_var('country_var')
----

The formula is then used as a filter, so only the rows that match the specified condition are displayed to the user.

The RLS rules support the `AND` operator, which means that you can combine multiple conditions in a single RLS rule, so that a row is accessible only if all specified conditions are met.

----
(country in ts_var('country_var')) and (department in ts_var('dept_var')) and (status = 'Active')
----

=== Verify the entitlements
To verify the entitlements:

. Log in to ThoughtSpot and start the user session with the ABAC token.
. Access a Liveboard, Saved Answer, or start a new search query.
. Inspect the generated SQL for your query or visualization.
. Verify if only permitted rows are displayed.
. Check if data is returned if no variable values are defined.
. Repeat the steps for different variable assignments to confirm the RLS rule is enforced as expected for all scenarios.

== ABAC with filter rules or Parameter values (Legacy ABAC method)
To generate a token with runtime filter rules or Parameter values, send a `POST` request to the `POST /api/rest/2.0/auth/token/custom` API endpoint with the following parameters in the request body:

* `persist_option`
* `filter_rules`
* `parameter_values`
* `objects`

The format for the objects in each section follows the equivalent formats in the Visual Embed SDK for xref:runtime-filters.adoc[runtime filters] and xref:runtime-parameters.adoc[runtime Parameters].

An example of setting both `filter_rules` and `parameter_values` without any persistence:

[source,JavaScript]
----
"persist_option": "NONE",
"filter_rules": [
   {
     "column_name": "Region",
     "operator": "IN",
     "values": ["West", "Southwest"]
   },
   {
     "column_name": "Product Type",
     "operator": "IN",
     "values": ["Shirts", "Swimwear"]
   }
 ],
 "parameter_values": [
   {
     "name": "Secured",
     "values": ["rxzricmwfe87q7bh7jyg"]
   }
 ]
----

[NOTE]
====
Passing an empty array in a filter column clears all filter rules and doesn't apply the filters on the column.
====

=== Apply to specific objects
By default, any specified filter or parameter will bind to any content with an exact match for the column or Parameter name.

You can choose the filter or Parameter to apply only to specific ThoughtSpot objects by including an `objects` array in the following format:

[source,JavaScript]
----
"objects": [
   {
     // example of the format
     "type": "{OBJECT_TYPE}",
     "identifier": "{id or name of the object}"
   },
   {
      "type": "LOGICAL_TABLE",
      "identifier": "9b751df2-d344-4850-9756-18535797378c"
   }
]
----

[NOTE]
====
The only supported object types for data security are logical tables.
====

[#persistForUser]
=== Token-based override versus persisting values
When using a `persist_option` other than `NONE`, the *filter_rules* and *parameter_values* defined in the token request using the `auth/token/custom` API endpoint are stored in the `user` > `access_control_properties` object.

Persisted values for a user are used by ThoughtSpot for any scheduled reports, as well as when no other token is provided.

[IMPORTANT]
====
* When `persist_option` is set to `NONE`, it only acts as an *override*, with the values tied only to the specific token. The REST API token request with any values where `persist_option` is not `NONE` acts as an "update the user object" API endpoint even if you don't use the token generated from the API request.
* Note that the stored properties of the user are updated when the token request is successful, rather than at the first use of the token.
====

The `persist_option` has the following possible values :

[cols="1,1,2"]
[options='header']
|=====
|value|available version|behavior

|`NONE`
|10.4.0.cl and later
|User properties are not updated by the token request.

|`APPEND`
|10.4.0.cl and later
|New attributes in the token request are added to existing properties of the user object.

|`RESET`
|10.4.0.cl and later
|All persisted attributes on the user object are cleared. New attributes defined in the API request are still encoded in the token.

|`REPLACE`
|10.5.0.cl and later
a|All persisted rules and attributes of the user object are replaced with the set specified in the token request.

[NOTE]
====
* By default, the `RESET` option resets all attributes.
//* In 10.6.0.cl and later versions, you can specify the attributes  to reset in the `reset_option` attribute. The `reset_option` allows resetting only filter rules, Parameters, or group properties in the token API request.
* In 10.4.0.cl, the `REPLACE` behavior can be achieved by making a `RESET` request followed by an `APPEND` request, then passing only the `APPEND` request token to the browser.
====
|=====

Filters and parameters must be *persisted* for them to apply to user sessions when using xref:trusted-authentication.adoc#cookie[cookie-based trusted authentication] or scheduled reports.

[cols="1,1,2"]
|=====
|persist|authentication type|behavior

|`NONE`
|Cookieless Trusted Authentication
|Attributes assigned to the token override the user's access control properties, without updating the user object.

|`NONE`
|Cookie-based Trusted Authentication
|Attributes assigned to the token will not be considered. The user logs in using a session cookie and  the properties from the previous session persist.

|`APPEND` or `REPLACE`
|Cookieless Trusted Authentication
|Attributes assigned to the token override the user's access control properties, but the user object is also updated

|`APPEND` or `REPLACE`
|Cookie-based Trusted Authentication
|Token request updates the user's access control properties and the token is used by the Visual Embed SDK to start a session.

|`APPEND` or `REPLACE`
|Discard token after request
|Token request updates the user object.
|=====

Persisting values opens up use cases for ABAC outside of the cookieless Trusted Authentication pattern: even if users authenticate via SAML, OIDC, or go directly into ThoughtSpot via username and password, an administrator can make a token request with a `persist_option` to write `filter_rules` and `parameter_values` to the user object.

=== Reset persisted values
To fully remove all persisted `filter_rules` or `parameter_values` from a user object, set `"persist_option" : "RESET"` in the token request.

The requested token can still be used for ABAC if you included `filter_rules` or `parameter_values` in the request.

=== Token request test page
A downloadable, customizable web page for testing all of the ABAC and trusted authentication capabilities is link:https://github.com/thoughtspot/ts_everywhere_resources/tree/master/examples/abac_with_token_auth[available on GitHub^].

The username specified in the test page must have Administrator privilege, or you can supply the *secret_key* for the ThoughtSpot instance to request a token for any user,  along with setting their ABAC properties.

See the xref:trusted-authentication.adoc[trusted authentication] documentation for full details on proper setup to allow trusted authentication.

=== Filter rules for multi-value RLS
The ABAC via tokens pattern allows for setting arbitrary filters and overriding the values of existing Worksheet parameters. These two capabilities can be combined in various ways to create secure and unbreakable RLS.

==== Deny all by default
Starting in ThoughtSpot 10.4.0.cl, you can add `is_mandatory_token_filter: true` to the TML definition of any column in a Model.

ThoughtSpot checks to see if the logged-in user has any `filter_rules` defined for a column marked with `is_mandatory_filter: true`, and denies access to any data if a filter rule for the matching column is not found.

==== Show All
The way to show all values for a column protected by `is_mandatory_token_filter: true` is to pass the special keyword `["TS_WILDCARD_ALL"]` as the value for the column in the `filter_rules`.

Columns without `is_mandatory_token_filter: true` will show all values if there is no `filter_rule` for that column.

==== Build the ABAC token request
The xref:trusted-auth-token-request-service.adoc[token request service] must have the following to build a token request for ABAC:

1. Filter rules for defining multi-value conditions on columns
2. Parameter values for use in Model formulas

The filter rules must be built by:

1. Retrieving user data entitlements
2. Translating entitlements into ThoughSpot `filter_rules`

===== Retrieve entitlements
The value of the ABAC pattern is that you can send different combinations of filters for different types of users.

You can retrieve the attribute names and values from any source: the embedding application's session details, an entitlement REST API, a query to a different database, etc.

===== Translate entitlements into filter rules

Filter rules *match on the name property of a column* as defined in ThoughtSpot, not the column's name in the underlying database table.

The xref:trusted-auth-token-request-service.adoc[token request service] *MUST* know the ThoughtSpot column names that will be used for each of the attributes, so you'll need to coordinate between ThoughtSpot Worksheet designers and the xref:trusted-auth-token-request-service.adoc[token request service] to make sure the matching column names and values are being sent.

[IMPORTANT]
====
[#dev-deploy-warning]
End users of an embedded app cannot have *edit* access to any Model using ABAC tokens.

You must follow xref:development-and-deployment.adoc[proper development and deployment practices] for all your customer-facing production environments as well as the production token request service.
====

As mentioned in the preceding section, the format for filter rules within the token matches with xref:runtime-filters.adoc[runtime filters] in the Visual Embed SDK. In general, RLS entitlements are lists of values using the `IN` operator, but you can pass in filters on numeric and time columns using the full set of operators.

All values are passed into the token as __arrays of strings__, even if the column is a numeric, boolean, or date type in ThoughtSpot and the database. The column data type will be respected in the query issued to the database.

For example, let's assume three attributes that are needed to filter down a user on a multi-tenanted database: `Customer ID`, `Region`, and `Product Type`.

The following is what the token request would look like if restricting on all three attributes:

[source,JavaScript]
----
"filter_rules": [
   {
     "column_name" : "Customer ID",
     "operator": "EQ",
     "values": ["492810"]
  },
   {
     "column_name": "Region",
     "operator": "IN",
     "values": ["West", "Southwest"]
   },
   {
     "column_name": "Product Type",
     "operator": "IN",
     "values": ["Shirts", "Swimwear"]
   }
 ]
----

A user might be entitled to *all access* on any given column (you might drop some levels of a hierarchy if you include more granular columns to filter on for that user).

The following is a request where a different user can see all regions, but still has restrictions on `Customer ID` and `Product Type`, using the `TS_WILDCARD_ALL` value to allow data even when the column expects a filter from the token:

[source,javascript]
----
"filter_rules": [
   {
     "column_name" : "Customer ID",
     "operator": "EQ",
     "values": ["TS_WILDCARD_ALL"]
   },
   {
     "column_name" : "Customer ID",
     "operator": "EQ",
     "values": ["492810"],
  },
   {
     "column_name": "Product Type",
     "operator": "IN",
     "values": ["Shirts", "Swimwear"],
   }
 ]
----

Because the `filter_rules` section is entirely within the control of the *token request service*, you have full flexibility to generate any set of filters for any type of user within the token.

=== Parameters to filter via formulas
The basic pattern for using a Parameter to filter a Model includes these steps:

. Create link:https://docs.thoughtspot.com/cloud/latest/parameters-create[Parameters, window=_blank] in Worksheet
. Create a link:https://docs.thoughtspot.com/cloud/latest/formulas[formula, window=_blank] that evaluates the Parameter's default value and the expected values from the token.
. Create a link:https://docs.thoughtspot.com/cloud/latest/filters#_worksheet_filters[filter, window=_blank] based on the formula, set to `true`.

link:https://docs.thoughtspot.com/cloud/latest/parameters-create[Parameters, target=_blank] are defined at the Worksheet level within ThoughtSpot. Parameters have a data type and a default value set by the Worksheet author.

You can also add `is_hidden: true` to a Parameter definition using TML, which allows the flexibility to use as many parameters as desired for any type of formula to be used as a Worksheet filter, without cluttering the visible UI.

To use a Parameter, you'll create a link:https://docs.thoughtspot.com/cloud/latest/formulas[formula, window=_blank] on the Model. link:https://docs.thoughtspot.com/cloud/latest/filters#_worksheet_filters[Filters, window=_blank] can reference formulas once they have been created, which creates the security layer out of the result derived from the formula.

All of these features are available in the edit mode of the Model.

////
[.bordered]
[.widthAuto]
image:./images/worksheet_edit_sidebar.png[Worksheet Edit Sidebar]
////
==== Create the security formula in the Model
A Parameter doesn't do anything on its own. You need a formula to evaluate the Parameter's value.

Any security formula to be used on a Worksheet should result in a *boolean* true or false, and then the Worksheet filter will be set to only return data when the formula returns true.

===== Logic for groups to see all data
In any security formula you build, you may want a clause that gives access to all data to certain groups.

You can chain together any number of `if...then...else` clauses within a formula, including using the `ts_groups` or `ts_username` values, to build out your preferred logic:

`if ( 'data developers' in ts_groups ) then true else if ( parameter_name = field_name ) then true else false`

===== Formulas comparing a Parameter to a column
Parameters can be used in a formula to directly match a value in a column, or any other type of function you'd like to use:

`if ( parameter_name = field_name ) then true else false`

[#worksheet-filter]
==== Set a filter on the Model security formula
The last step is to set a *filter* on the *formula* you just created to evaluate the 'check parameter'.

. Click the Add new icon (+) next to *Filters*. +
. Click the formula you created (at the end of the list) in the *Filter* dialog.
+

[.bordered]
image:./images/new_worksheet_filter_step_1.png[Create New Filter on Worksheet, width=449, height=589]
+
. Click *Add values in bulk*.
+
[.bordered]
image:./images/new_worksheet_filter_step_2.png[Choose add values in bulk, width=449, height=589]

. Type in the value *true* in the bulk dialog box, and then click *Done*.
+
[.bordered]
image:./images/new_worksheet_filter_step_3.png[Type in true in bulk values box, width=457, height=301]

. Click **Done** on the Filter dialog. +
You should see it listed on the *Edit Worksheet* page:
+

[.bordered]
image:./images/new_worksheet_filter_step_4.png[Completed Worksheet filter]

==== Use Parameters with pass-through functions
link:https://docs.thoughtspot.com/cloud/latest/formula-reference#passthrough-functions[ThoughtSpot SQL Pass-through functions, window=_blank] allow you to send arbitrary SQL to the data source, while passing in values to substitute from ThoughtSpot.

The basic form of the SQL Pass-through function is:

`sql_passthrough_function("<sql_statement>", <ThoughtSpot variable 1>, <ThoughtSpot variable 2>,...)`

The proper pass-through function to use in most cases is `sql_bool_op`, which can be used in a filter set to `true` as xref:#worksheet-filter[shown above].

The list of variables are substituted into the SQL statement using curly braces in the order listed, starting at 0:

`sql_bool_op ( "tableName.columnName IN ({0}, {1})" , parameterName0, parameterName1)`

If you do not get all your data types correct, the ThoughtSpot-generated query will cause errors at the data warehouse level, which you will see in ThoughtSpot.

===== Fully-qualify all column references
If you are using a column that is part of the current ThoughtSpot Worksheet, you can simply reference that column using the substitution syntax of the pass-through functions:

`sql_bool_op ( "{0} IN ({1}, {2})" , columnInWorksheet, parameterName0, parameterName1)`

If you are referencing a field NOT in ThoughtSpot, perhaps a column that is not part of the JOINed data model or of a complex data type ThoughtSpot does not natively recognize, you need to *fully-qualify the column name* with at minimum `tableName.columnName` syntax in your query, so that the SQL is not ambiguous if a similar column name exists on multiple tables.

You may need a full `database.schema.tableName.columnName` syntax, in the standard syntax of the particular data warehouse being used, for the SQL to work within the rest of the ThoughtSpot-generated query.

===== Sub-queries to solve multi-step filtering scenarios
Many reporting solutions require very complex logic to establish a user's data entitlements.

Traditionally, this can be solved by either writing dynamically generated SQL queries into an application or by placing the logic within a database in a way that the results of the logic can be referenced easily by other SQL queries. This may involve stored procedures, user-defined functions, temporary tables or any of the many other tools provided by a given RDBMS.

ThoughtSpot does not allow for the writing of *arbitrary dynamic SQL*. Pass-through functions must be written and remain the same for all users, with *ThoughtSpot Parameters* being the only aspect that can be changed dynamically.

Writing a *sub-query* as a pass-through function, with a parameter whose value is provided securely via ABAC, provides a method for accessing any number of tables or features within your data warehouse, while guaranteeing the filter will be applied to all searches made using the ThoughtSpot Worksheet.

The basic form of the sub-query formula is:

`sql_bool_op('{0} IN (SELECT DatabaseField FROM FullyQualifiedTable WHERE OtherField = {1})', WorksheetField , Param)`

The SQL, when expanded, will look like:

[,sql]
----
ws.FieldNameAlias IN (
   SELECT DatabaseField
   FROM FullyQualifiedTable
   WHERE OtherField = '{ParameterValue}'
)
----

You could similarly call a UDF or stored procedure that returns a column of the same type as the WorksheetField:

`sql_bool_op('{0} IN (udf_function_name({1}))', WorksheetField , Param)`

The overall pattern is to use the Parameter value, sent in via ABAC, to retrieve a specific set of values set within the database, using whatever techniques are available.

An example workflow might be:

1. User logs into the embedding application.
2. A stored procedure is called in the database to grab their latest entitlements and store those in a table, with a single "entitlement_session_id" returned to the application.
3. The "entitlement_session_id" is sent as an ABAC parameter as part of the ThoughtSpot token request for the user.
4. Worksheets that need these entitlements use the combination of pass-through function with parameter + formula + filter so that all queries in ThoughtSpot include a WHERE clause with the sub-select.

== Additional resources

* For information about variable APIs, see xref:variables.adoc[Variable APIs].
* For information about assigning security entitlements via ABAC tokens, see xref:abac-user-parameters.adoc[ABAC via tokens].
* For information about RLS rule definitions, see link:https://docs.thoughtspot.com/cloud/latest/security-rls[RLS rules documentation, window=_blank].
