= Prerender embed components
:toc: true
:toclevels: 3

:page-title: Prerender components
:page-pageid: prerender
:page-description: Prerender components to optimize user experience of your embedding application

ThoughtSpot supports the following rendering options for the embed components:

* Normal render +
Normal render is the default behavior of the ThoughtSpot SDK. It loads the ThoughtSpot app when the component is rendered.
* Pre-Render +
Pre-renders the embed as soon as the component code is rendered. With this, the amount of ThoughtSpot assets left to load when the user accesses the embedded content is reduced.
* On-demand pre-rendering +
Pre-renders after the embed component is rendered at least once.

== Overview
Pre-rendering allows application to load ThoughtSpot embed components in the background. You can use pre-rendering for performance optimization, reducing iframe initialization delays, and for seamless transition between the embed views and application pages.

The prerender feature creates a placeholder element for the ThoughtSpot component. To preload it effectively, place the element in a section of your app that users see before accessing the component. For example, analytics applications often have custom landing pages that direct users to embedded content. Preloading the component on this page ensures it is ready to render when users click on a link.

The following figure illustrates the benefits of the pre-render method:

image::./images/prerender.png[prerender]

=== When to use prerender

Use prerender in the following cases:

* If you want to preload an embed component, such as a Liveboard, Spotter interface, or full application, before it's shown to the user.
* Your application has a tabbed interface with multiple embed views or your embed involves switching between pages, and you want to show the components on the next page instantly.

== How to pre-render components
To pre-render a component:

. Add pre-render options to your embed code. +
In this example, let's add a pre-render ID to the Liveboard embed instance.
+
[source,JavaScript]
----
const liveboardEmbed = new LiveboardEmbed('#embed', {
  liveboardId: '<your-liveboard-id>',
  preRenderId: 'my-prerender-id', // Unique ID for this pre-render instance
  // Optionally, disable dynamic size tracking:
  // doNotTrackPreRenderSize: true,
});
----
You can also pre-render a generic instance in the background using the `prerenderGeneric` method. This preloads a generic instance of the component (without a specific path) in the background and applies flags. The `liveboardId` is passed when your embed is rendered. This is a generic pre-render where only the basic assets needed for rendering the app are loaded.
This method might not be as fast as pre-rendering with `liveboardId` but it is faster than normal rendering.

+
[source,JavaScript]
----
await liveboardEmbed.prerenderGeneric();
----
. Create a placeholder shell. +
This sets up the pre-render shell and is hidden by default.

+
[source,JavaScript]
----
await liveboardEmbed.preRender();
----
. Show pre-rendered component.
+
[source,JavaScript]
----
await liveboardEmbedembed.showPreRender();
----
. For style synchronization such as adjusting the position, width, and height of the pre-rendered component to match the embedding element, call the `syncPreRenderStyle` method to ensure a seamless display of styles.
+
[source,JavaScript]
----
embed.syncPreRenderStyle();
----

== Code sample

[source,JavaScript]
----
import {
    LiveboardEmbed,
    AuthType,
    init,
    prefetch,
} from '@thoughtspot/visual-embed-sdk';

// Initialize SDK
init({
    thoughtSpotHost: 'https://<your-thoughtspot-host>',
    authType: AuthType.None,
});

//Create LiveboardEmbed instance
const liveboardEmbed = new LiveboardEmbed('#embed', {
    liveboardId: '<your-liveboard-id>', //Replace with your actual Liveboard ID
    preRenderId: 'my-prerender-id', //Replace with the actual ID
});

// Pre-render in the background
liveboardEmbed.showPreRender();

//Show the pre-rendered component when needed
document.getElementById('show-liveboard-btn').onclick = () => {
    liveboardEmbed.render();
};
----

== Best Practices
* Use unique `preRenderId` values for each separate embed.
* Place the pre-render shell in the DOM early (on page mount).
* If using `prerenderGeneric`, call this method early.
* Avoid multiple re-instantiations. Initialize once and reuse the instance.
* Use `full-height` if necessary.

== SDK reference for pre-rendering methods and properties

The Visual Embed SDK provides the following methods and properties for pre-rendering embed components:

[width="100%" cols="7,7,7"]
[options="header"]
|====
| Name
| Description
| Example
| xref:AppEmbed.adoc#_prerender[preRender]
| This method creates `preRender` shell. Optionally, shows the preRender after rendering components.
a| `await embed.preRender();`
| xref:AppEmbed.adoc#_prerendergeneric[prerenderGeneric]
| This method pre-renders a generic instance of the ThoughtSpot embed component.
| `await embed.prerenderGeneric();`
| xref:AppEmbed.adoc#_showprerender[showPreRender]
| This method displays the pre-rendered component. If the component is not pre-rendered, it creates and renders it.
| `await embed.showPreRender();`
| xref:AppEmbed.adoc#_hideprerender[hidePreRender]
| This method hides the pre-rendered component if available.
| `embed.hidePreRender();`
| xref:AppViewConfig.adoc#_getprerenderids[getPreRenderIds]
| This method retrieves unique HTML element IDs for pre-render-related elements, based on `preRenderId`.
| `embed.getPreRenderIds();`
| xref:AppEmbed.adoc#_getprerenderids[preRenderId]
| This configuration property allows defining the object ID for the pre-rendered instance. Can be used with `showPreRender`/`hidePreRender`.
| `preRenderId: "preRenderId-123"`
| xref:AppEmbed.adoc#_syncprerenderstyle[syncPreRenderStyle]
| This method synchronizes style, position, width, height of the pre-rendered component with embedding element.
| `embed.syncPreRenderStyle();`
| xref:AppViewConfig.adoc#_donottrackprerendersize[doNotTrackPreRenderSize]
| This configuration setting disables dynamic size tracking for pre-render component when set to true.
| `doNotTrackPreRenderSize: true`
|====

== Additional resources

* link:https://github.com/thoughtspot/developer-examples/tree/main/visual-embed/pre-rendering[Pre-rendering examples GitHub repository, window=_blank]
* link:https://codesandbox.io/p/sandbox/github/thoughtspot/developer-examples/tree/main/visual-embed/pre-rendering[Code sandbox, window=_blank]


////
== Prerender

You can load ThoughtSpot components that are not specific to the user's session before your application user accesses the embedded content.


=== How it works

Pre-render allows developers to pre-load the ThoughtSpot application in the background before the user navigates to the embedded content.

It allows you to create a placeholder element on the page for the Liveboard to eventually populate. To preload components, you must place this element into a section of your application that will be viewed before the Liveboard. For example, it is common for analytics applications to have a custom-built landing page that directs users to relevant pieces of embedded content. This would be an ideal place to preload the component, so the frame is ready to render by the time the user clicks on a specific link.

=== How to implement prerender

Depending on the framework and project, you can implement this using xref:_standard_js[Standard JavaScript] or xref:_react[React].

==== Standard JS

If using Javascript:

. Create a container for the Liveboard and a placeholder.
+
For this approach, you require two containers:

* a `div` container with `absolute` position. This will eventually be used to render the Liveboard.
* a placeholder `div`. This is the container designated for the Liveboard, which you will set as the primary embed container in your application code. When it is time to load a Liveboard, move the prerender `div` on top of the placeholder `div`.

+
[source,HTML]
----
<div id="placeholder"></div>
<div id="prerender"></div>
----

+
[source,HTML]
----
#prerender{
  position: absolute;
  opacity: 0;
  left: 0;
  top: 0;
  height: 0;
  width: 0;
}
----

. PreRender ThoughtSpot
+
Inside the prerender `div`, you can create a placeholder for Liveboard embedding. Before calling the Liveboard GUID, call `prerenderGeneric` to start the load process for the primary embed and transfer the bulk of the information needed by ThoughtSpot to the client browser.

+
[source,JavaScript]
----
let renderDiv = document.getElementById("prerender");
let embed = new LiveboardEmbed(renderDiv, {
  frameParams: {
    height: "1200px"
  }
});
embed.prerenderGeneric();
----

. Render the embedded Liveboard
+
When it is time for the user to view a specific liveboard, move the `prerender div` onto the placeholder, and instruct the Liveboard Embed to load the required content. To do this, use the `navigateToLiveboard` function on the embed object:

+
[source,JavaScript]
----
//Navigate embed container to new liveboard id 

let liveboardID = "16b8c2e2-edfc-4e42-8827-98387f384b1b"
embed.navigateToLiveboard(liveboardID)

//Obtain the current bounds of the placeholder element
let placeholderDiv = document.getElementById("placeholder");
const coords = placeholderDiv.getBoundingClientRect();
const offset = getOffset(placeholderDiv);

//Move the renderer into those bounds
renderDiv.style.opacity = 1;
renderDiv.style.top = offset.top + "px";
renderDiv.style.left = offset.left + "px";
renderDiv.style.width = coords.width + "px";
renderDiv.style.height = coords.height + "px";

function getOffset(el) {
  var _x = 0;
  var _y = 0;
  while (el && !isNaN(el.offsetLeft) && !isNaN(el.offsetTop)) {
    _x += el.offsetLeft - el.scrollLeft;
    _y += el.offsetTop - el.scrollTop;
    el = el.offsetParent;
  }
  return { top: _y, left: _x };
}
----

==== React

If using React, make sure the container is not continuously reloaded with state changes. You can use a context provider to achieve this. For more information, see link:https://react.dev/learn/passing-data-deeply-with-context[https://react.dev/learn/passing-data-deeply-with-context, window=_blank].

[Source,TypeScript]
----
const prerenderdLiveboardContext = createContext<any>({});
----

This approach requires two containers. The first is a `div` with absolute position. This will eventually be used to render the liveboard.

The second is a placeholder. This is the container designated for the Liveboard, which you will set as the primary embed container in your application code. When loading the Liveboard, move the `prerender div` on top of the placeholder div.

. Create render shell
+
This is a `div` element with absolute position. Use context variables to control the divâ€™s visibility and coordinate position. This div also holds the embedded Liveboard, and the `liveboardId` is set by the respective context variable.

+
By default, this `div` will be invisible and placed into a corner of the page (0 coordinates), with no `liveboardId`.

+
[source,TypeScript]
----
export const PrerenderedLiveboardShell = () => {
  
  const ref = useRef(null);
  const lb = useRef<LiveboardEmbed | null>(null);
  const { isVisible, liveboardId, coords } = useContext(
    prerenderdLiveboardContext
  );

  return (
    <div
      id="prerender"
      style={{
        opacity: isVisible ? 1 : 0,
        ...coords,
        position: "absolute"
      }}
      ref={ref}
    ></div>
  );
}
----

. Pre-render the embed container
+
.. Create a Liveboard embed within this `div`.
.. Before calling the Liveboard GUID, call `prerenderGeneric` to start the load process for the primary embed and transfer  the bulk of the information needed by ThoughtSpot to render content to the client browser.
.. Pass an empty array into `useEffect`.

+
[source,TypeScript]
----
useEffect(() => {
  if (!ref.current) {
    return;
  }
  lb.current = new LiveboardEmbed(ref.current, {
    frameParams: {
      height: "1200px"
    }
  });
  lb.current.prerenderGeneric();
}, []);
----

. Navigate to Liveboard
+
Update the render container when the user is ready to view the Liveboard. For this, use the previously defined context variable that sets the `liveboardId`, and leverage `useEffect` to register the changes to this ID. When the Liveboard ID is updated, render the new Liveboard by using the `navigateToLiveboard` function:
+
[source,TypeScript]
----
useEffect(() => {
  if (!liveboardId) {
    return;
  }
  lb.current?.navigateToLiveboard(liveboardId);
}, [liveboardId]);
----

. Create context provider
+
To manage context variables and render the shell we next need to create a provider component:

+
[Source,TypeScript]
----
export const PrerenderdLiveboardProvider = ({ children }) => {
  const [isVisible, setIsVisible] = useState(false);
  const [liveboardId, setLiveboardId] = useState();
  const [coords, setCoords] = useState({
    left: 0,
    top: 0,
    height: 0,
    width: 0
  });
  return (
    <prerenderdLiveboardContext.Provider
      value={{
        isVisible,
        setIsVisible,
        liveboardId,
        setLiveboardId,
        coords,
        setCoords
      }}
    >
      {children}
      <PrerenderedLiveboardShell />
    </prerenderdLiveboardContext.Provider>
  );
};
----

. Add this code to your application
+
In this example, the primary content is in a component named `LiveboardBrowser`. It includes a list of different liveboards that a user can choose from, and a space on the page to render the Liveboard. The IDs are hard-coded in this example. However, you can populate this via a REST call.

+
[source,TypeScript]
----
init({
thoughtSpotHost: "https://my.thoughtspot.cloud/",
authType: AuthType.None, // AuthType.Passthrough
})

function App() {
  return (
    <div className="App">
      <PrerenderdLiveboardProvider>
        <LiveboardBrowser></LiveboardBrowser>
      </PrerenderdLiveboardProvider>
    </div>
  );
}
----

. Render a Liveboard
+
.. Set our context variables
.. Specify the GUID of the Liveboard
.. Set coordinates for the element the shell will overlay
.. Set visibility to `true`.

+
[source,TypeScript]
----
function toggleLiveboardSelect(e){
  setLiveboardId(e.target.value);
  const coords = ref.current.getBoundingClientRect();
  const offset = getOffset(ref.current);
  setCoords({
    height: coords.height,
    width: coords.width,
    top: offset.top,
    left: offset.left
  });
  setIsVisible(true);
}
----

== Turn on CDN

Using a Content Delivery Network (CDN) reduces the time to pre-render static or dynamic ThoughtSpot assets by caching resources closer to the end user. When your application users navigate to ThoughtSpot very quickly after the embedding application loads, they need not wait for assets to finish pre-rendering.

The following figure illustrates the benefits of using CDN:

image::./images/cdn.png[CDN]

////

