= Git Integration REST API guide
:toc: true
:toclevels: 2

:page-title: Git REST API guide
:page-pageid: git-rest-api-guide
:page-description: Guide to Git Integration REST APIs

== Overview
The `/vcs/git/` endpoints of the V2.0 REST API provide all of the functionality necessary to xref:git-configuration.adoc[configure], perform version control, and deploy changes to different ThoughtSpot environments.

The xref:version_control.adoc#moving-tml-changes-between-environments[basic process] is: 

1. xref:git-rest-api-guide.adoc#commit-files[Commit changes] into a "dev" branch from the "dev" Org
2. xref:version_control.adoc#moving-changes-from-one-branch-to-another[Move those changes] to other branches via Git
3. xref:git-rest-api-guide.adoc#deploy-commits[Deploy commits] into the *destination branch* (eventually "main" or "prod")

The following is a guide to using the REST APIs available for Git integration after you have completed xref:git-configuration.adoc[configuration] for the ThoughtSpot instance.

== Commit files

ThoughtSpot users with data management (*Can manage data*) privilege can download TML files to their local environment, xref:modify-tml.adoc[edit TML files], and import them into ThoughtSpot via UI or REST API. With Git integration, users can also push commits from a ThoughtSpot instance to a Git branch via `/api/rest/2.0/vcs/git/branches/commit` API call.

=== Request parameters
[width="100%" cols="2,8"]
[options='header']
|===
|Parameter|Description
|`metadata`|__Array of Strings__. Specify the `type` and GUID of the metadata object.
|`delete_aware` a|__Boolean__. When `delete_aware` is true, upon committing files, a check is run between the files in the Git branch and the objects in the ThoughtSpot environment. If an object exists in the Git branch, but not in the ThoughtSpot instance or Org, the object will be deleted from the Git branch. The `delete_aware` parameter is enabled by default.
[NOTE]
====
The `delete_aware` property requires you to associate one ThoughtSpot environment or Org to one commit branch in Git. Associating multiple ThoughtSpot environments to the same Git commit branch will result in files getting unintentionally deleted across your environments during a commit operation.
====

|`branch_name` +
__Optional__|__String__. Name of the branch in the Git repository to which you want to push the commit. If you do not specify the branch name, the commit will be pushed to the `commit_branch_name` defined for the xref:version_control.adoc#connectTS[Git connection configuration].
|`comment`|__String__. Add a comment to the commit.
||
|===

=== Request example

The following example shows the API request with Liveboard and Worksheet objects to commit to Git.

[source,cURL]
----
curl -X POST \
  --url 'https://{ThoughtSpot-Host}/api/rest/2.0/vcs/git/branches/commit' \
  -H 'Authorization: Bearer {Bearer_token}\
  -H 'Accept: application/json'\
  -H 'Content-Type: application/json' \
  --data-raw '{
  "metadata": [
    {
      "identifier": "e9d54c69-d2c1-446d-9529-544759427075",
      "type": "LIVEBOARD"
    },
    {
      "identifier": "cd252e5c-b552-49a8-821d-3eadaa049cca",
      "type": "LOGICAL_TABLE"
    }
  ],
  "delete_aware": true,
  "comment": "Add objects",
  "branch_name": "prod"
}'
----

=== Results

During this operation, a check is performed to compare the objects in the Git branch with the objects in the ThoughtSpot environment.

* If an object exists in the Git branch, but not in the ThoughtSpot instance or Org, the object will be deleted from the Git branch.
* If the object does not exist in the Git branch, it will be added to the Git branch specified in the API request or `commit_branch_name` configured for the Git connection.
* If the object exists on both the Git branch and ThoughtSpot cluster or Org and there are no changes detected in the commit, the API returns a warning message with a list of objects that were not updated as part of the commit.

The following figure illustrates the commit operation with the `delete_aware` property enabled:

[.widthAuto]
image::./images/delete-aware-commit.png[Commit changes]

== Deploy commits

To deploy commits to the `Staging` or `Prod` instance, send a `POST` request to the `/api/rest/2.0/vcs/git/commits/deploy` API endpoint. The API will deploy the head of the branch unless a `commit_id` is specified in the API request.

Building a release version for a `Prod` environment on the same instance requires swapping in the correct GUIDs. If you have enabled xref:guid-mapping.adoc[GUID mapping] in the Git configuration on your deployment instance, the version control APIs will automatically generate a GUID mapping file and update object references when deploying your commits to the destination environment.

Please see the xref:guid-mapping.adoc[GUID mapping] documentation to understand how it works and additional capabilities for handling other substitutions that may be necessary during the deploy commits process for the destination environment.

[NOTE]
====
Parallel deployment to multiple organizations within a single cluster is not supported. Developers must run deployments to each organization sequentially.
====

////
Make sure the *guid mapping file* is referenced when creating the final TML files for production rollout.
////

=== Request parameters
[width="100%" cols="2,4"]
[options='header']
|=====
|Parameter|Description
|`commit_id` +
__Optional__|__String__. ID of the commit to deploy on the cluster. By default, the command will deploy the head of the branch. To deploy a specific version, specify the `commit_id`.
|`branch_name` |__String__. Name of the branch from which the commit must be picked for deployment. If you do not specify the branch name, the commit from the default branch is deployed.
|`deploy_type` a| __String__. Specify one of the following options: +

* `DELTA` (default) +
Deploys only the changes that were applied at the specified `commit_id`. For example, if three TML files were updated in the `commit_id` specified in the API request, only those changes will be deployed.
* `FULL` +
Deploys all the files in the Git branch, including the files from the `commit_id` specified in the request and all other files that were already committed.

|`deploy_policy` a|__String__. Action to apply when deploying a commit. The allowed values are: +

* `ALL_OR_NONE` (Default) +
Deploys all changes or none. This option cancels the deployment of all ThoughtSpot objects if at least one of them fails to import.
* `PARTIAL` +
Deploys partial objects. This option imports the subset of ThoughtSpot objects that validate successfully even if other objects in the same deploy operations fail to import.
* `VALIDATE_ONLY` +
Runs validation to detect if your destination environment can import the changes without conflicts. Use this when the TML content is modified between source and destination environments and if you do not want the TML content in your destination branch to be modified after a pull request from your dev branch.
||
|=====


=== Request example

[source,cURL]
----
curl -X POST \
  --url 'https://{ThoughtSpot-Host}/api/rest/2.0/vcs/git/commits/deploy' \
  -H 'Authorization: Bearer {Bearer_token}'\
  -H 'Accept: application/json'\
  -H 'Content-Type: application/json' \
  --data-raw '{
  "deploy_type": "DELTA",
  "deploy_policy": "ALL_OR_NONE",
  "commit_id": "afc0fea831558e30d7064ab019f49243b1f09552",
  "branch_name": "main"
}'
----

=== Results

If the API request is successful, the changes are applied to the objects in the `prod` environment. A tracking file is generated in the Git branch used for storing configuration files. This file includes the `commit_id` specified in the API request.

The subsequent API calls to deploy commits will consider the saved `commit_id` and `deploy_type` specified in the API request:

* If `deploy_type` is set as `DELTA`, all the changes between the last tracked `commit id` and the new `commit_id` specified in the API request will be deployed to the destination environment or Org.
* If the `deploy_type` is  FULL`, all the files from the `commit_id` specified in the API request will be deployed. If any object or file is deleted in the commit specified in the API request, it will be deleted from the destination environment during deployment.

== Validate merge

To merge updates, create a pull request to push changes from your `dev` branch to `main`. ThoughtSpot doesn't provide REST APIs to merge content from one branch to another. Before accepting the merge request in the Git repository, you can validate the merge on your ThoughtSpot instance using REST API.

To validate the content of your `dev` branch against your `prod` environment, send a `POST` request from your `prod` instance to the `/api/rest/2.0/vcs/git/branches/validate` API endpoint.

[NOTE]
====
Due to GUID mapping requirements in most destination environments, it is currently preferable to use the Deploy Commits endpoint with the `deploy_policy=VALIDATE_ONLY` option rather than the Validate Merge endpoint.
====

=== Request parameters
[width="100%" cols="2,4"]
[options='header']
|=====
|Parameter|Description
|`source_branch_name`|__String__. Name of the source branch from which changes need to be picked for validation.
|`target_branch_name`|__String__. Name of the target branch into which the TML changes will be merged.
||
|=====

=== Request example

The following example shows the API request with Liveboard and Worksheet objects to commit to Git.

[source,cURL]
----
curl -X POST \
  --url 'https://{ThoughtSpot-Host}/api/rest/2.0/vcs/git/branches/validate' \
  -H 'Authorization: Bearer {Bearer_token}\
  -H 'Accept: application/json'\
  -H 'Content-Type: application/json' \
  --data-raw '{
  "source_branch_name": "dev",
  "target_branch_name": "main"
}'
----

=== Results

After validating the merge, check for conflicts. Resolve issues if any with a new commit and merge your changes to the `main` branch.


== Search commits

ThoughtSpot provides a REST API endpoint to search commits for a given TML object. A `POST` call to the `/api/rest/2.0/vcs/git/commits/search` endpoint with `metadata` identifier and `type` in the request body fetches a list of commits.



== Revert a commit
To undo the changes committed to a repository, revert to a previous commit and restore an earlier version of an object using the `/v2/vcs/commits/{commit_id}/revert` API endpoint.

==== Request parameters
[width="100%" cols="2,4"]
[options='header']
|=====
|Parameter|Description
|`commit_id`|__String__. ID of the commit to which you want to revert.
|`metadata` +
__Optional__|__Array of Strings__. Specify the `type` and GUID of the metadata object. If a metadata object is not specified, the API request reverts all objects that were modified as part of the specified `commit_id`.
|`branch_name` +
__Optional__|__String__. Name of the branch to which the revert operation must be applied. If you do not specify the branch name, the API will revert the commit to the default branch configured on that ThoughtSpot instance.
|`revert_policy` a|__String__. Action to apply when reverting a commit. The allowed values are: +

* `ALL_OR_NONE`  (Default) +
Reverts all objects. If the revert operation fails for one of the objects provided in the commit, the API returns an error and does not revert any object.

* `PARTIAL` +
Reverts partial objects. This option reverts the subset of ThoughtSpot objects that validate successfully even if the other objects in the commit fail to import.
||
|=====

=== Request example

The following example shows the API request for reverting a commit.

[source,cURL]
----
curl -X POST \
  --url 'https://{ThoughtSpot-Host}/api/rest/2.0/vcs/git/commits/afc0fea831558e30d7064ab019f49243b1f09552/revert' \
  -H 'Authorization: Bearer {Bearer_token}\\
  -H 'Accept: application/json'\
  -H 'Content-Type: application/json' \
  --data-raw '{
  "metadata": [
    {
      "identifier": "e9d54c69-d2c1-446d-9529-544759427075",
      "type": "LIVEBOARD"
    }
  ],
  "commit_id": "afc0fea831558e30d7064ab019f49243b1f09552",
  "branch_name": "dev"
}'
----

=== Results

If the API request is successful, the Git branch is reverted to the specified commit ID.


